generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           Int        @id @default(autoincrement())
  username     String?    @unique
  email        String?    @unique
  phone        String?    @unique
  googleId     String?    @unique
  passwordHash String?
  role         String     @default("USER") // 'USER' | 'ADMIN'
  avatarURL    String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  submittedDeals Deal[] 
  comments       Comment[]
  wishlist       Wishlist[]
  blogs          Blog[]
}

model Store {
  id               Int      @id @default(autoincrement())
  name             String
  slug             String   @unique
  logoURL          String?
  affiliateBaseURL String?
  isPopular        Boolean  @default(false)
  
  deals            Deal[]
}

model Category {
  id       Int      @id @default(autoincrement())
  name     String
  slug     String   @unique
  iconURL  String?

  parentId Int?
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")
  
  deals    Deal[]
}

model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique
  slug  String @unique
  deals Deal[] @relation("DealTags")
}

model Deal {
  id                 Int       @id @default(autoincrement())
  title              String
  description        String?
  originalPrice      Float?
  discountedPrice    Float?
  discountPercentage Float?
  couponCode         String?
  expiryDate         DateTime?
  affiliateLink      String?
  isLootDeal         Boolean   @default(false)
  
  // Analytics Tracking
  clickCount         Int       @default(0)
  viewsCount         Int       @default(0)
  likesCount         Int       @default(0)

  // Moderation / Submission
  status             String    @default("APPROVED") // 'PENDING' | 'APPROVED' | 'REJECTED'
  submitterId        Int?
  submitter          User?     @relation(fields: [submitterId], references: [id], onDelete: SetNull)

  storeId            Int
  store              Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  categoryId         Int
  category           Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  tags               Tag[]      @relation("DealTags")
  comments           Comment[]
  wishlistedBy       Wishlist[]

  @@index([categoryId])
  @@index([discountPercentage])
  @@index([status])
  @@index([expiryDate])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  isFlagged Boolean  @default(false)
  createdAt DateTime @default(now())
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dealId    Int
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Wishlist {
  userId Int
  dealId Int
  addedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@id([userId, dealId])
}

model Blog {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  content     String
  imageUrl    String?
  metaTitle   String?
  metaDesc    String?
  status      String   @default("DRAFT") // 'PUBLISHED' | 'DRAFT'
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  authorId    Int
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}
